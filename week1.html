<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feelings Fun! ğŸ­</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap');

:root {
  --bg: #FFF8E7;
  --text: #2D3436;
  --card-bg: #FFFFFF;
  --shadow: rgba(45, 52, 54, 0.1);
  --radius: 20px;
  --accent: #A29BFE;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(circle at 10% 20%, rgba(255,217,61,0.15) 0%, transparent 50%),
    radial-gradient(circle at 90% 80%, rgba(162,155,254,0.12) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(255,133,202,0.08) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

.app { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; padding: 16px; }

.header { text-align: center; padding: 20px 0 10px; }
.header h1 {
  font-family: 'Fredoka', sans-serif;
  font-size: 2.4rem;
  font-weight: 700;
  background: linear-gradient(135deg, #FF6B6B, #A29BFE, #FFD93D);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header .subtitle { font-size: 1rem; color: #636E72; margin-top: 4px; font-weight: 600; }

.score-bar { display: flex; justify-content: center; gap: 20px; margin: 12px 0; flex-wrap: wrap; }
.score-item {
  background: white;
  padding: 8px 18px;
  border-radius: 50px;
  font-weight: 700;
  font-size: 0.95rem;
  box-shadow: 0 2px 10px var(--shadow);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: transform 0.3s;
}
.score-item.pop { animation: pop 0.4s ease; }
@keyframes pop { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

.nav-tabs { display: flex; gap: 8px; justify-content: center; margin: 16px 0; flex-wrap: wrap; }
.nav-tab {
  padding: 10px 20px;
  border-radius: 50px;
  border: 2px solid #DFE6E9;
  background: white;
  font-family: 'Fredoka', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  color: #636E72;
}
.nav-tab:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow); }
.nav-tab.active {
  background: linear-gradient(135deg, #A29BFE, #FF85CA);
  color: white;
  border-color: transparent;
  box-shadow: 0 4px 16px rgba(162,155,254,0.4);
}

.section { display: none; animation: fadeIn 0.4s ease; }
.section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }

/* ===== LEARN ===== */
.feelings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 14px;
  margin-top: 10px;
}
.feeling-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 18px 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 0 3px 15px var(--shadow);
  border: 3px solid transparent;
  position: relative;
}
.feeling-card:hover { transform: translateY(-6px) scale(1.03); box-shadow: 0 8px 25px var(--shadow); }
.feeling-card:active { transform: scale(0.95); }
.feeling-card .emoji { font-size: 2.8rem; margin-bottom: 8px; display: block; }
.feeling-card .word { font-family: 'Fredoka', sans-serif; font-size: 1.15rem; font-weight: 600; color: var(--text); }
.feeling-card .chinese { font-size: 0.85rem; color: #636E72; margin-top: 2px; }
.feeling-card .speaker-hint {
  position: absolute; top: 8px; right: 8px;
  font-size: 1rem; opacity: 0.3; transition: opacity 0.2s;
}
.feeling-card:hover .speaker-hint { opacity: 0.7; }
.feeling-card.speaking {
  border-color: var(--accent);
  animation: speakRing 0.6s ease;
}
@keyframes speakRing {
  0%, 100% { box-shadow: 0 3px 15px var(--shadow); }
  50% { box-shadow: 0 0 0 6px rgba(162,155,254,0.3), 0 3px 15px var(--shadow); }
}

.sentence-practice {
  background: white;
  border-radius: var(--radius);
  padding: 24px;
  margin-top: 20px;
  box-shadow: 0 3px 15px var(--shadow);
  text-align: center;
}
.sentence-practice h3 { font-family: 'Fredoka', sans-serif; font-size: 1.2rem; color: var(--text); margin-bottom: 14px; }
.sentence-display {
  font-size: 1.6rem;
  font-family: 'Fredoka', sans-serif;
  font-weight: 600;
  color: #2D3436;
  padding: 14px;
  background: #F8F9FA;
  border-radius: 14px;
  margin-bottom: 14px;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  flex-wrap: wrap;
  line-height: 1.4;
}
.sentence-display .hl { color: var(--accent); font-weight: 700; }

.btn-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
.speak-btn {
  padding: 12px 28px;
  border-radius: 50px;
  border: none;
  font-family: 'Fredoka', sans-serif;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.speak-btn:hover { transform: translateY(-2px); }
.speak-btn:active { transform: scale(0.95); }
.speak-btn.primary {
  background: linear-gradient(135deg, #A29BFE, #6C5CE7);
  color: white;
  box-shadow: 0 4px 15px rgba(108,92,231,0.3);
}
.speak-btn.secondary {
  background: linear-gradient(135deg, #FFD93D, #FDCB6E);
  color: #2D3436;
  box-shadow: 0 4px 15px rgba(253,203,110,0.3);
}
.speak-btn.small { padding: 8px 18px; font-size: 0.95rem; }
.speak-btn.playing { opacity: 0.7; pointer-events: none; }

.feeling-chips { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 14px; }
.feeling-chip {
  padding: 8px 16px;
  border-radius: 50px;
  border: 2px solid #DFE6E9;
  background: white;
  font-family: 'Fredoka', sans-serif;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.feeling-chip:hover { background: #F8F9FA; transform: scale(1.05); }
.feeling-chip.selected { border-color: var(--accent); background: #F0EDFF; }

/* ===== MATCH ===== */
.match-feedback {
  text-align: center; padding: 16px;
  font-family: 'Fredoka', sans-serif; font-size: 1.3rem; font-weight: 600;
  min-height: 56px; display: flex; align-items: center; justify-content: center;
}
.match-game { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
.match-column h3 { font-family: 'Fredoka', sans-serif; text-align: center; margin-bottom: 12px; color: #636E72; font-size: 1rem; }
.match-item {
  padding: 14px 18px; border-radius: 14px; margin-bottom: 10px;
  cursor: pointer; transition: all 0.3s;
  font-family: 'Fredoka', sans-serif; font-size: 1.1rem; font-weight: 600;
  text-align: center; user-select: none;
  background: white; border: 3px solid #DFE6E9; box-shadow: 0 2px 10px var(--shadow);
}
.match-item.emoji-item { font-size: 2rem; }
.match-item:hover { transform: scale(1.05); }
.match-item.selected { border-color: var(--accent); background: #F0EDFF; box-shadow: 0 4px 16px rgba(162,155,254,0.3); }
.match-item.correct { border-color: #00B894; background: #E8FFF5; animation: correctBounce 0.5s ease; }
.match-item.wrong { border-color: #FF6B6B; background: #FFE8E8; animation: shake 0.4s ease; }
.match-item.matched { opacity: 0.35; pointer-events: none; transform: scale(0.95); }
@keyframes correctBounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.12); } }
@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

.reset-btn {
  display: block; margin: 16px auto 0;
  padding: 12px 32px; border-radius: 50px; border: none;
  background: linear-gradient(135deg, #FFD93D, #FDCB6E);
  color: #2D3436;
  font-family: 'Fredoka', sans-serif; font-size: 1.05rem; font-weight: 600;
  cursor: pointer; transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(253,203,110,0.3);
}
.reset-btn:hover { transform: translateY(-2px); }

/* ===== QUIZ ===== */
.quiz-container {
  background: white; border-radius: var(--radius); padding: 30px;
  box-shadow: 0 3px 15px var(--shadow); text-align: center;
}
.quiz-progress { display: flex; gap: 6px; justify-content: center; margin-bottom: 20px; }
.quiz-dot { width: 12px; height: 12px; border-radius: 50%; background: #DFE6E9; transition: all 0.3s; }
.quiz-dot.done { background: #00B894; }
.quiz-dot.current { background: var(--accent); transform: scale(1.3); }
.quiz-dot.wrong-dot { background: #FF6B6B; }
.quiz-prompt { font-size: 3.5rem; margin: 20px 0; }
.quiz-question { font-family: 'Fredoka', sans-serif; font-size: 1.3rem; color: #636E72; margin-bottom: 20px; }
.quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; max-width: 500px; margin: 0 auto; }
.quiz-option {
  padding: 16px; border-radius: 14px; border: 3px solid #DFE6E9;
  background: white; font-family: 'Fredoka', sans-serif; font-size: 1.15rem; font-weight: 600;
  cursor: pointer; transition: all 0.3s;
}
.quiz-option:hover { border-color: var(--accent); transform: translateY(-2px); }
.quiz-option.correct-answer { border-color: #00B894; background: #E8FFF5; }
.quiz-option.wrong-answer { border-color: #FF6B6B; background: #FFE8E8; }

.quiz-result { padding: 30px; text-align: center; }
.quiz-result .big-emoji { font-size: 4rem; margin-bottom: 16px; }
.quiz-result .result-text { font-family: 'Fredoka', sans-serif; font-size: 1.6rem; font-weight: 700; margin-bottom: 8px; }
.quiz-result .result-detail { font-size: 1.1rem; color: #636E72; margin-bottom: 20px; }

/* ===== SIGHT WORDS ===== */
.sight-words-area { display: flex; flex-direction: column; gap: 14px; }
.sight-word-card {
  background: white; border-radius: var(--radius); padding: 20px 24px;
  display: flex; align-items: center; justify-content: space-between;
  box-shadow: 0 3px 15px var(--shadow); cursor: pointer; transition: all 0.3s;
}
.sight-word-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px var(--shadow); }
.sight-word-card:active { transform: scale(0.97); }
.sight-word-text { font-family: 'Fredoka', sans-serif; font-size: 2rem; font-weight: 700; color: var(--text); }
.sight-word-chinese { font-size: 1rem; color: #636E72; margin-top: 2px; }
.sight-word-card .play-icon {
  width: 48px; height: 48px; border-radius: 50%;
  background: linear-gradient(135deg, #A29BFE, #6C5CE7);
  display: flex; align-items: center; justify-content: center;
  color: white; font-size: 1.3rem; flex-shrink: 0;
}
.sight-word-card.speaking { border-left: 5px solid var(--accent); }

/* Speed toggle */
.speed-toggle {
  display: flex; gap: 6px; justify-content: center; margin: 10px 0;
}
.speed-btn {
  padding: 6px 14px; border-radius: 50px;
  border: 2px solid #DFE6E9; background: white;
  font-family: 'Fredoka', sans-serif; font-size: 0.85rem; font-weight: 600;
  cursor: pointer; color: #636E72; transition: all 0.2s;
}
.speed-btn.active { border-color: var(--accent); background: #F0EDFF; color: var(--accent); }

.confetti-box { position: fixed; inset: 0; pointer-events: none; z-index: 100; }
.confetti-piece {
  position: absolute; width: 10px; height: 10px; border-radius: 2px;
  animation: confDrop 2s ease-out forwards;
}
@keyframes confDrop {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

@media (max-width: 600px) {
  .header h1 { font-size: 1.8rem; }
  .feelings-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
  .feeling-card { padding: 14px 8px; }
  .feeling-card .emoji { font-size: 2.2rem; }
  .match-game { grid-template-columns: 1fr; }
  .quiz-options { grid-template-columns: 1fr; }
  .nav-tab { padding: 8px 14px; font-size: 0.9rem; }
  .sentence-display { font-size: 1.2rem; }
}
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <h1>Feelings Fun! ğŸ­</h1>
    <div class="subtitle">å­¸ç¿’è¡¨é”æƒ…ç·’çš„è‹±æ–‡ Â· Learn to express feelings</div>
    <div style="font-size:0.7rem;color:#B2BEC3;margin-top:2px;font-family:'Nunito',sans-serif;">v1.3.2</div>
  </div>

  <div class="score-bar">
    <div class="score-item" id="starBar"><span>â­</span> <span id="stars">0</span> Stars</div>
    <div class="score-item" id="streakBar"><span>ğŸ”¥</span> <span id="streak">0</span> Streak</div>
  </div>

  <div class="speed-toggle">
    <button class="speed-btn" data-speed="slow" id="speedSlow">ğŸ¢ Slow</button>
    <button class="speed-btn active" data-speed="normal" id="speedNormal">ğŸ‡ Normal</button>
  </div>
  <div id="engineStatus" style="text-align:center;font-size:0.8rem;color:#B2BEC3;margin-bottom:6px;font-family:'Nunito',sans-serif;">ğŸ” åµæ¸¬ä¸­...</div>

  <div class="nav-tabs">
    <button class="nav-tab active" data-tab="learn">ğŸ“– Learn</button>
    <button class="nav-tab" data-tab="match">ğŸ¯ Match</button>
    <button class="nav-tab" data-tab="quiz">ğŸ§  Quiz</button>
    <button class="nav-tab" data-tab="sight">ğŸ‘€ Sight Words</button>
  </div>

  <div id="learn" class="section active">
    <div class="feelings-grid" id="feelingsGrid"></div>
    <div class="sentence-practice">
      <h3>ğŸ—£ï¸ Practice Sentences é€ å¥ç·´ç¿’</h3>
      <div class="sentence-display" id="sentenceDisplay">I feel <span class="hl">happy</span>. ğŸ˜Š</div>
      <div class="btn-row">
        <button class="speak-btn primary" id="speakSentenceBtn">ğŸ”Š Listen è½ç™¼éŸ³</button>
        <button class="speak-btn secondary" id="randomSentenceBtn">ğŸ² Random éš¨æ©Ÿ</button>
      </div>
      <div class="feeling-chips" id="feelingChips"></div>
    </div>
  </div>

  <div id="match" class="section">
    <div class="match-feedback" id="matchFeedback">é»ä¸€å€‹å–®å­—ï¼Œå†é»é…å°çš„è¡¨æƒ…ï¼ ğŸ¯</div>
    <div class="match-game" id="matchGame">
      <div class="match-column" id="matchWords"><h3>Words å–®å­—</h3></div>
      <div class="match-column" id="matchEmojis"><h3>Emoji è¡¨æƒ…</h3></div>
    </div>
    <button class="reset-btn" id="resetMatch">ğŸ”„ New Round å†ä¾†ä¸€æ¬¡</button>
  </div>

  <div id="quiz" class="section">
    <div class="quiz-container" id="quizContainer"></div>
  </div>

  <div id="sight" class="section">
    <div class="sight-words-area" id="sightWordsArea"></div>
  </div>
</div>

<div class="confetti-box" id="confettiBox"></div>

<script>
// ===== DATA =====
const feelings = [
  { word: 'happy',   zh: 'é–‹å¿ƒçš„', emoji: 'ğŸ˜Š', color: '#FFD93D' },
  { word: 'sad',     zh: 'é›£éçš„', emoji: 'ğŸ˜¢', color: '#74B9FF' },
  { word: 'angry',   zh: 'ç”Ÿæ°£çš„', emoji: 'ğŸ˜ ', color: '#FF6B6B' },
  { word: 'excited', zh: 'èˆˆå¥®çš„', emoji: 'ğŸ¤©', color: '#FF85CA' },
  { word: 'silly',   zh: 'å‚»å‚»çš„', emoji: 'ğŸ¤ª', color: '#A29BFE' },
  { word: 'tired',   zh: 'ç´¯çš„',   emoji: 'ğŸ˜´', color: '#B2BEC3' },
  { word: 'scared',  zh: 'å®³æ€•çš„', emoji: 'ğŸ˜¨', color: '#81ECEC' },
  { word: 'bored',   zh: 'ç„¡èŠçš„', emoji: 'ğŸ˜‘', color: '#FFEAA7' },
  { word: 'sick',    zh: 'ä¸èˆ’æœçš„', emoji: 'ğŸ¤’', color: '#55EFC4' },
  { word: 'proud',   zh: 'é©•å‚²çš„', emoji: 'ğŸ˜', color: '#FD79A8' },
  { word: 'brave',   zh: 'å‹‡æ•¢çš„', emoji: 'ğŸ’ª', color: '#E17055' },
  { word: 'mad',     zh: 'å¾ˆç”Ÿæ°£', emoji: 'ğŸ˜¤', color: '#D63031' },
];

const sightWords = [
  { word: 'door',  zh: 'é–€', sentence: 'Open the door.' },
  { word: 'down',  zh: 'ä¸‹é¢', sentence: 'Sit down please.' },
  { word: 'dress', zh: 'æ´‹è£', sentence: 'I like your dress.' },
  { word: 'duck',  zh: 'é´¨å­', sentence: 'Look at the duck!' },
  { word: 'each',  zh: 'æ¯ä¸€å€‹', sentence: 'Give one to each child.' },
  { word: 'egg',   zh: 'è›‹', sentence: 'I eat an egg.' },
  { word: 'every', zh: 'æ¯å€‹', sentence: 'Every day is special.' },
];
const sightColors = ['#FF6B6B','#A29BFE','#FFD93D','#00B894','#FF85CA','#74B9FF','#E17055'];

// ===== STATE =====
let stars = 0, streak = 0, currentFeeling = 'happy';
let matchSelected = null, matchedPairs = new Set();
let quizQuestions = [], quizIndex = 0, quizScore = 0, quizAnswered = false;
let speechSpeed = 'normal'; // 'slow' or 'normal'

// ===== TTS ENGINE =====
// Reuse a single Audio element â€” iOS Safari blocks play() on newly created Audio objects
// unless triggered by a direct user gesture. By reusing one element "unlocked" on first tap,
// subsequent src changes + play() calls work reliably.
const sharedAudio = new Audio();
let audioUnlocked = false;
let lastEngine = 'none';

// Unlock audio on first user interaction (iOS requirement)
function unlockAudio() {
  if (audioUnlocked) return;
  sharedAudio.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=';
  sharedAudio.play().then(() => {
    audioUnlocked = true;
    sharedAudio.pause();
    console.log('Audio unlocked for iOS');
  }).catch(() => {});
  // Also unlock SpeechSynthesis
  if (window.speechSynthesis) {
    const u = new SpeechSynthesisUtterance('');
    u.volume = 0;
    speechSynthesis.speak(u);
  }
}
document.addEventListener('touchstart', unlockAudio, { once: true });
document.addEventListener('click', unlockAudio, { once: true });

function updateEngineDisplay(engine, detail) {
  lastEngine = engine;
  const el = document.getElementById('engineStatus');
  if (engine === 'google-tts') {
    el.textContent = `ğŸŸ¢ Google TTS${detail ? ' â€” ' + detail : ''}`;
    el.style.color = '#00B894';
  } else if (engine === 'speech-synthesis') {
    el.textContent = `ğŸŸ¡ SpeechSynthesis (fallback)${detail ? ' â€” ' + detail : ''}`;
    el.style.color = '#FDCB6E';
  } else if (engine === 'error') {
    el.textContent = `ğŸ”´ ç„¡æ³•ç™¼éŸ³${detail ? ' â€” ' + detail : ''}`;
    el.style.color = '#FF6B6B';
  } else {
    el.textContent = 'ğŸ” åµæ¸¬ä¸­...';
    el.style.color = '#B2BEC3';
  }
}

// Queue for chained speak calls (word â†’ sentence)
let speakQueue = [];
let speakBusy = false;

function speak(text, forceSpeed) {
  // Stop any in-progress audio
  sharedAudio.pause();
  if (window.speechSynthesis) speechSynthesis.cancel();
  speakQueue = [];
  speakBusy = false;

  return _doSpeak(text, forceSpeed);
}

function _doSpeak(text, forceSpeed) {
  const speed = forceSpeed || speechSpeed;
  const slow = speed === 'slow';
  const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=en&client=tw-ob&q=${encodeURIComponent(text)}${slow ? '&ttsspeed=0.3' : ''}`;

  sharedAudio.src = url;
  sharedAudio.playbackRate = slow ? 0.75 : 1.0;
  sharedAudio.onplay = () => updateEngineDisplay('google-tts', text);
  // Clear old handlers
  sharedAudio.onended = null;
  sharedAudio.onerror = null;

  const playPromise = sharedAudio.play();
  if (playPromise) {
    playPromise.catch(err => {
      console.warn('Google TTS failed, fallback:', err.message);
      updateEngineDisplay('speech-synthesis', err.message);
      speakFallback(text, slow);
    });
  }

  return sharedAudio;
}

// Fallback: SpeechSynthesis (in case Google TTS is blocked)
// macOS has many novelty voices (Albert, Bad News, Bells, etc.) â€” filter those out
const noveltyVoices = new Set([
  'Albert','Bad News','Bahh','Bells','Boing','Bubbles','Cellos','Good News',
  'Jester','Organ','Superstar','Trinoids','Whisper','Wobble','Zarvox',
  'Ralph','Fred','Kathy','Junior','Princess'
]);

function pickBestVoice(voices) {
  // Prefer high-quality en-US voices by name
  const preferred = ['Samantha','Alex','Karen','Daniel','Moira','Tessa','Ava','Tom','Allison'];
  for (const name of preferred) {
    const v = voices.find(v => v.name.includes(name) && v.lang.startsWith('en'));
    if (v) return v;
  }
  // Any en-US voice that isn't a novelty voice
  const enUS = voices.filter(v => v.lang === 'en-US' && !noveltyVoices.has(v.name));
  if (enUS.length) return enUS[0];
  // Any English voice that isn't novelty
  const en = voices.filter(v => v.lang.startsWith('en') && !noveltyVoices.has(v.name));
  if (en.length) return en[0];
  // Last resort
  return voices.find(v => v.lang.startsWith('en')) || voices[0];
}

function speakFallback(text, slow) {
  const synth = window.speechSynthesis;
  if (!synth) {
    updateEngineDisplay('error', 'SpeechSynthesis not available');
    return;
  }
  synth.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  u.rate = slow ? 0.6 : 0.85;
  u.pitch = 1.05;
  const pick = pickBestVoice(synth.getVoices());
  if (pick) u.voice = pick;
  u.onstart = () => updateEngineDisplay('speech-synthesis', pick ? pick.name : 'default voice');
  u.onerror = (e) => updateEngineDisplay('error', e.error);
  synth.speak(u);
}

// Speak word first, then sentence after a pause â€” uses shared Audio element
function speakWordThenSentence(word, sentence) {
  speak(word);
  sharedAudio.onended = () => {
    setTimeout(() => _doSpeak(sentence), 400);
  };
}

// ===== SPEED TOGGLE =====
document.querySelectorAll('.speed-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    speechSpeed = btn.dataset.speed;
  });
});

// ===== UTILS =====
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function addStars(n) {
  stars += n;
  document.getElementById('stars').textContent = Math.floor(stars);
  const el = document.getElementById('starBar');
  el.classList.remove('pop');
  void el.offsetWidth;
  el.classList.add('pop');
}

function bumpStreak() {
  streak++;
  document.getElementById('streak').textContent = streak;
  const el = document.getElementById('streakBar');
  el.classList.remove('pop');
  void el.offsetWidth;
  el.classList.add('pop');
}

function resetStreak() { streak = 0; document.getElementById('streak').textContent = 0; }

function doConfetti() {
  const box = document.getElementById('confettiBox');
  const colors = ['#FFD93D','#FF6B6B','#A29BFE','#FF85CA','#00B894','#74B9FF'];
  for (let i = 0; i < 35; i++) {
    const p = document.createElement('div');
    p.className = 'confetti-piece';
    p.style.left = Math.random() * 100 + '%';
    p.style.background = colors[Math.floor(Math.random() * colors.length)];
    p.style.animationDelay = Math.random() * 0.5 + 's';
    p.style.animationDuration = (1.5 + Math.random()) + 's';
    const size = 6 + Math.random() * 8;
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    box.appendChild(p);
  }
  setTimeout(() => box.innerHTML = '', 3000);
}

// ===== NAV =====
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
    if (tab.dataset.tab === 'match') initMatch();
    if (tab.dataset.tab === 'quiz') initQuiz();
    if (tab.dataset.tab === 'sight') initSightWords();
  });
});

// ===== LEARN =====
function initLearn() {
  const grid = document.getElementById('feelingsGrid');
  grid.innerHTML = '';
  feelings.forEach(f => {
    const card = document.createElement('div');
    card.className = 'feeling-card';
    card.innerHTML = `
      <span class="speaker-hint">ğŸ”Š</span>
      <span class="emoji">${f.emoji}</span>
      <div class="word">${f.word}</div>
      <div class="chinese">${f.zh}</div>
    `;
    card.style.borderBottom = `4px solid ${f.color}`;
    card.addEventListener('click', () => {
      card.classList.add('speaking');
      setTimeout(() => card.classList.remove('speaking'), 800);
      speak(f.word);
      selectFeeling(f.word);
    });
    grid.appendChild(card);
  });

  const chips = document.getElementById('feelingChips');
  chips.innerHTML = '';
  feelings.forEach(f => {
    const chip = document.createElement('button');
    chip.className = 'feeling-chip' + (f.word === currentFeeling ? ' selected' : '');
    chip.textContent = `${f.emoji} ${f.word}`;
    chip.addEventListener('click', () => {
      selectFeeling(f.word);
      speak(`I feel ${f.word}.`);
    });
    chips.appendChild(chip);
  });
}

function selectFeeling(word) {
  currentFeeling = word;
  const f = feelings.find(x => x.word === word);
  document.getElementById('sentenceDisplay').innerHTML =
    `I feel <span class="hl">${word}</span>. ${f?.emoji || ''}`;
  document.querySelectorAll('.feeling-chip').forEach(c => {
    c.classList.toggle('selected', c.textContent.includes(word));
  });
}

document.getElementById('speakSentenceBtn').addEventListener('click', () => speak(`I feel ${currentFeeling}.`));
document.getElementById('randomSentenceBtn').addEventListener('click', () => {
  const r = feelings[Math.floor(Math.random() * feelings.length)];
  selectFeeling(r.word);
  speak(`I feel ${r.word}.`);
});

// ===== MATCH =====
function initMatch() {
  const pool = shuffle(feelings).slice(0, 6);
  const wCol = document.getElementById('matchWords');
  const eCol = document.getElementById('matchEmojis');
  wCol.innerHTML = '<h3>Words å–®å­—</h3>';
  eCol.innerHTML = '<h3>Emoji è¡¨æƒ…</h3>';
  matchSelected = null;
  matchedPairs = new Set();
  document.getElementById('matchFeedback').textContent = 'é»ä¸€å€‹å–®å­—ï¼Œå†é»é…å°çš„è¡¨æƒ…ï¼ ğŸ¯';

  shuffle(pool).forEach(f => {
    const item = document.createElement('div');
    item.className = 'match-item';
    item.textContent = f.word;
    item.dataset.word = f.word;
    item.dataset.type = 'word';
    item.addEventListener('click', () => matchClick(item));
    wCol.appendChild(item);
  });
  shuffle(pool).forEach(f => {
    const item = document.createElement('div');
    item.className = 'match-item emoji-item';
    item.textContent = f.emoji;
    item.dataset.word = f.word;
    item.dataset.type = 'emoji';
    item.addEventListener('click', () => matchClick(item));
    eCol.appendChild(item);
  });
}

function matchClick(item) {
  if (item.classList.contains('matched')) return;

  if (!matchSelected) {
    matchSelected = item;
    item.classList.add('selected');
    if (item.dataset.type === 'word') speak(item.dataset.word);
    return;
  }
  if (matchSelected === item) {
    item.classList.remove('selected');
    matchSelected = null;
    return;
  }
  if (matchSelected.dataset.type === item.dataset.type) {
    matchSelected.classList.remove('selected');
    matchSelected = item;
    item.classList.add('selected');
    if (item.dataset.type === 'word') speak(item.dataset.word);
    return;
  }

  if (matchSelected.dataset.word === item.dataset.word) {
    const prev = matchSelected;
    prev.classList.remove('selected');
    prev.classList.add('correct');
    item.classList.add('correct');
    const f = feelings.find(x => x.word === item.dataset.word);
    speak(item.dataset.word);
    document.getElementById('matchFeedback').textContent = `âœ… ${f?.emoji} ${f?.word} = ${f?.zh}ï¼`;
    addStars(1); bumpStreak();
    setTimeout(() => {
      prev.classList.add('matched'); prev.classList.remove('correct');
      item.classList.add('matched'); item.classList.remove('correct');
    }, 600);
    matchedPairs.add(item.dataset.word);
    if (matchedPairs.size >= 6) {
      setTimeout(() => {
        document.getElementById('matchFeedback').textContent = 'ğŸ‰ å…¨éƒ¨é…å°å®Œæˆï¼å¤ªæ£’äº†ï¼';
        addStars(3); doConfetti();
      }, 700);
    }
  } else {
    const prev = matchSelected;
    prev.classList.add('wrong'); item.classList.add('wrong');
    resetStreak();
    document.getElementById('matchFeedback').textContent = 'âŒ å†è©¦ä¸€æ¬¡ï¼';
    setTimeout(() => {
      prev.classList.remove('wrong', 'selected');
      item.classList.remove('wrong');
    }, 500);
  }
  matchSelected = null;
}

document.getElementById('resetMatch').addEventListener('click', initMatch);

// ===== QUIZ =====
function initQuiz() {
  quizQuestions = shuffle(feelings).slice(0, 8).map(f => {
    const others = shuffle(feelings.filter(x => x.word !== f.word)).slice(0, 3);
    return { feeling: f, options: shuffle([f, ...others]), type: Math.random() > 0.5 ? 'e2w' : 'w2e' };
  });
  quizIndex = 0; quizScore = 0;
  renderQuiz();
}

function renderQuiz() {
  const c = document.getElementById('quizContainer');
  if (quizIndex >= quizQuestions.length) {
    const pct = Math.round(quizScore / quizQuestions.length * 100);
    const msg = pct === 100 ? 'ğŸ† Perfect! å®Œç¾ï¼' : pct >= 75 ? 'ğŸŒŸ Great! å¾ˆæ£’ï¼' : 'ğŸ’ª Keep going! åŠ æ²¹ï¼';
    c.innerHTML = `<div class="quiz-result">
      <div class="big-emoji">${pct === 100 ? 'ğŸ‰' : pct >= 75 ? 'ğŸŒŸ' : 'ğŸ’ª'}</div>
      <div class="result-text">${msg}</div>
      <div class="result-detail">${quizScore} / ${quizQuestions.length} ç­”å°</div>
      <button class="speak-btn primary" onclick="initQuiz()">ğŸ”„ å†ä¾†ä¸€æ¬¡</button>
    </div>`;
    if (pct >= 75) { addStars(5); doConfetti(); }
    return;
  }

  const q = quizQuestions[quizIndex];
  quizAnswered = false;
  const dots = quizQuestions.map((_, i) => `<div class="quiz-dot${i < quizIndex ? ' done' : ''}${i === quizIndex ? ' current' : ''}"></div>`).join('');

  if (q.type === 'e2w') {
    c.innerHTML = `
      <div class="quiz-progress">${dots}</div>
      <div class="quiz-prompt">${q.feeling.emoji}</div>
      <div class="quiz-question">é€™æ˜¯ä»€éº¼æ„Ÿè¦ºï¼Ÿ</div>
      <button class="speak-btn small primary" style="margin-bottom:16px" id="quizHint">ğŸ”Š è½æç¤º</button>
      <div class="quiz-options">
        ${q.options.map(o => `<button class="quiz-option" data-word="${o.word}">${o.word}</button>`).join('')}
      </div>`;
  } else {
    c.innerHTML = `
      <div class="quiz-progress">${dots}</div>
      <div class="quiz-prompt" style="font-size:2.2rem;font-family:'Fredoka',sans-serif;font-weight:700">${q.feeling.word}</div>
      <div class="quiz-question">å“ªå€‹è¡¨æƒ…ç¬¦åˆï¼Ÿ</div>
      <button class="speak-btn small primary" style="margin-bottom:16px" id="quizHint">ğŸ”Š è½ç™¼éŸ³</button>
      <div class="quiz-options">
        ${q.options.map(o => `<button class="quiz-option" data-word="${o.word}">${o.emoji} ${o.zh}</button>`).join('')}
      </div>`;
  }

  // Don't auto-speak â€” iOS blocks audio without a direct user gesture.
  // The hint button below lets the user trigger it.

  // Hint button
  c.querySelector('#quizHint')?.addEventListener('click', () => speak(q.feeling.word));

  c.querySelectorAll('.quiz-option').forEach(btn => {
    btn.addEventListener('click', () => {
      if (quizAnswered) return;
      quizAnswered = true;
      const correct = btn.dataset.word === q.feeling.word;
      if (correct) {
        btn.classList.add('correct-answer');
        quizScore++; addStars(1); bumpStreak();
        speak('Great job!');
      } else {
        btn.classList.add('wrong-answer');
        resetStreak();
        c.querySelector(`[data-word="${q.feeling.word}"]`)?.classList.add('correct-answer');
        speak(q.feeling.word);
      }
      setTimeout(() => { quizIndex++; renderQuiz(); }, 1300);
    });
  });
}

// ===== SIGHT WORDS =====
function initSightWords() {
  const area = document.getElementById('sightWordsArea');
  area.innerHTML = '';

  sightWords.forEach((sw, i) => {
    const card = document.createElement('div');
    card.className = 'sight-word-card';
    card.style.borderLeft = `5px solid ${sightColors[i]}`;
    card.innerHTML = `
      <div>
        <div class="sight-word-text">${sw.word}</div>
        <div class="sight-word-chinese">${sw.zh} â€” "${sw.sentence}"</div>
      </div>
      <div class="play-icon">ğŸ”Š</div>`;
    card.addEventListener('click', () => {
      card.classList.add('speaking');
      setTimeout(() => card.classList.remove('speaking'), 1500);
      speakWordThenSentence(sw.word, sw.sentence);
    });
    area.appendChild(card);
  });

  const extra = document.createElement('div');
  extra.className = 'sentence-practice';
  extra.style.marginTop = '8px';
  extra.innerHTML = `
    <h3>ğŸ“Œ Weekly Quote æ¯é€±ä½³å¥</h3>
    <div class="sentence-display" style="font-size:1.3rem">"Life is better when you are happy." ğŸ˜Š</div>
    <button class="speak-btn primary small" onclick="speak('Life is better when you are happy.')">ğŸ”Š Listen</button>
    <div style="margin-top:18px">
      <h3>ğŸµ Song & Rhyme</h3>
      <div class="sentence-display" style="font-size:1.4rem;margin-top:8px">âœ¨ Hakuna Matata âœ¨</div>
      <button class="speak-btn secondary small" onclick="speak('Hakuna Matata! It means no worries!')">ğŸ”Š Listen</button>
    </div>`;
  area.appendChild(extra);
}

// ===== INIT =====
initLearn();

// Pre-warm: load voices for fallback
if (window.speechSynthesis) {
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}
</script>
</body>
</html>
